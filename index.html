<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Менеджер графиков света</title>
  
  <!-- Materialize CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- HTML2Canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* --- OVERRIDES FOR DARK THEME --- */
    :root {
      --bg: #0f1724;
      --card-bg: #1e293b;
      --text-main: #e6eef6;
      --text-muted: #94a3b8;
      --accent: #6ee7b7; /* Teal-ish green */
      --accent-dark: #059669;
      --danger: #fb7185;
      --border: rgba(255,255,255,0.1);
    }

    body {
      background-color: var(--bg);
      color: var(--text-main);
      font-family: 'Inter', sans-serif;
    }

    /* Navbar / Header styling */
    nav {
      background-color: transparent;
      box-shadow: none;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    nav .brand-logo {
      font-size: 1.5rem;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Cards */
    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text-main);
    }
    .card-content {
      padding: 20px;
    }

    /* Inputs & Textareas (Dark Mode overrides) */
    .input-field input[type=text], 
    .input-field textarea.materialize-textarea {
      color: var(--text-main);
      border-bottom: 1px solid var(--border);
    }
    .input-field input[type=text]:focus, 
    .input-field textarea.materialize-textarea:focus {
      border-bottom: 1px solid var(--accent);
      box-shadow: 0 1px 0 0 var(--accent);
    }
    .input-field label {
      color: var(--text-muted);
    }
    .input-field input[type=text]:focus + label, 
    .input-field textarea.materialize-textarea:focus + label {
      color: var(--accent);
    }

    /* Tabs */
    .tabs {
      background-color: transparent;
      border-bottom: 1px solid var(--border);
    }
    .tabs .tab a {
      color: var(--text-muted);
      font-weight: 600;
    }
    .tabs .tab a:hover, .tabs .tab a.active {
      color: var(--accent);
      background-color: rgba(110, 231, 183, 0.05);
    }
    .tabs .indicator {
      background-color: var(--accent);
    }

    /* Buttons */
    .btn, .btn-large {
      background-color: var(--accent);
      color: #0f1724;
      font-weight: 700;
    }
    .btn:hover, .btn-large:hover {
      background-color: #34d399;
    }
    .btn-flat {
      color: var(--text-main);
    }
    .btn:disabled {
      background-color: #334155 !important;
      color: #64748b !important;
    }

    /* Chips (Tags) */
    .chip {
      background-color: rgba(255,255,255,0.1);
      color: var(--text-main);
    }
    .chip.added {
      background-color: rgba(110, 231, 183, 0.15);
      color: var(--accent);
    }
    .chip.removed {
      background-color: rgba(251, 113, 133, 0.15);
      color: var(--danger);
    }

    /* Result Row (Comparator) */
    .diff-row {
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 10px 15px;
    }
    .diff-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    details {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed var(--border);
    }
    summary {
      color: var(--text-muted);
      cursor: pointer;
      outline: none;
    }

    /* --- MODAL STYLING (VISUALIZER) --- */
    .modal {
      background-color: var(--card-bg);
      color: var(--text-main);
      max-height: 90%;
      width: 95%; /* Wider modal for chart */
      max-width: 1400px;
      border-radius: 12px;
    }
    .modal .modal-footer {
      background-color: #162032;
      border-top: 1px solid var(--border);
    }
    /* Fix scrollbar in modal */
    .modal-content {
      padding: 24px;
    }

    /* --- CHART GRID STYLES --- */
    .chart-scroll-wrapper {
      overflow-x: auto;
      padding-bottom: 10px;
      /* Custom Scrollbar */
      scrollbar-width: thin;
      scrollbar-color: var(--accent) var(--bg);
    }
    .chart-scroll-wrapper::-webkit-scrollbar {
      height: 8px;
    }
    .chart-scroll-wrapper::-webkit-scrollbar-track {
      background: var(--bg);
    }
    .chart-scroll-wrapper::-webkit-scrollbar-thumb {
      background-color: var(--accent);
      border-radius: 4px;
    }

    #chart-grid {
      display: grid;
      /* 1st col (label): 180px, then 48 slots */
      grid-template-columns: 180px repeat(48, minmax(20px, 1fr));
      background-color: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      min-width: 1200px; /* Force scroll on mobile */
    }

    .grid-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid var(--border);
      border-right: 1px solid var(--border);
      font-size: 12px;
      height: 45px;
      color: var(--text-muted);
      position: relative;
    }

    /* Header Cells (Time) */
    .header-cell {
      background-color: rgba(110,231,183,0.05);
      color: var(--accent);
      font-weight: bold;
      grid-column: span 2; /* 1 hour = 2 slots */
    }

    /* Label Cells (Groups) */
    .label-cell {
      background-color: rgba(110,231,183,0.05);
      color: var(--text-main);
      font-weight: 600;
      justify-content: space-between; /* Space between name and time */
      padding: 0 12px;
      text-align: left;
      border-right: 2px solid var(--accent); /* Separator */
      white-space: nowrap;
    }
    .label-cell span.total-time {
      font-size: 0.85em;
      color: var(--accent);
      opacity: 0.9;
      margin-left: 8px;
    }

    /* Data Cells */
    .data-cell.off {
      background-color: rgba(251, 113, 133, 0.15);
      color: var(--danger);
    }
    /* Remove last borders */
    .grid-cell:nth-child(49n+1) { border-right: none; } /* Logic adjusted for grid structure */
    
    /* FOOTER TOTAL ROW */
    .grid-footer {
      grid-column: 1 / -1; /* Span ALL columns */
      background-color: rgba(255,255,255,0.03);
      color: var(--text-main);
      padding: 12px 20px;
      font-weight: 600;
      border-top: 2px solid var(--border);
      text-align: right;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
    }
    .grid-footer strong {
      color: var(--accent);
      font-size: 1.1em;
    }

    /* Utilities */
    .hidden { display: none !important; }
    .mt-2 { margin-top: 1rem; }
    .mb-2 { margin-bottom: 1rem; }
    
    .helper-text { color: var(--text-muted); font-size: 0.9rem; margin-top: -10px; margin-bottom: 20px; display: block;}

  </style>
</head>
<body>

  <div class="container">
    
    <!-- HEADER -->
    <nav>
      <div class="nav-wrapper">
        <a href="#" class="brand-logo">
          <i class="material-icons" style="color: var(--accent)">bolt</i>
          <span style="font-size: 1.2rem; font-weight: 600;">Графики Света</span>
        </a>
      </div>
    </nav>

    <!-- TABS -->
    <div class="row">
      <div class="col s12">
        <ul class="tabs">
          <li class="tab col s6"><a class="active" href="#comparator">Сравнение</a></li>
          <li class="tab col s6"><a href="#visualizer">Визуализатор</a></li>
        </ul>
      </div>
    </div>

    <!-- VIEW 1: COMPARATOR -->
    <div id="comparator" class="col s12">
      <div class="card">
        <div class="card-content">
          <div class="row">
            <div class="input-field col s12 m6">
              <textarea id="old" class="materialize-textarea" placeholder="1.1: 00:00-04:00"></textarea>
              <label for="old">Старый график</label>
            </div>
            <div class="input-field col s12 m6">
              <textarea id="new" class="materialize-textarea" placeholder="1.1: 00:00-03:00"></textarea>
              <label for="new">Новый график</label>
            </div>
          </div>

          <div class="row">
            <div class="col s12">
               <label>
                <input type="checkbox" id="onlyChanges" />
                <span style="color: var(--text-main)">Показать только изменения</span>
              </label>
            </div>
          </div>

          <div class="row" style="margin-top: 20px;">
            <div class="col s12">
              <button id="compareBtn" class="btn waves-effect waves-light">Сравнить</button>
              <button id="clearBtn" class="btn-flat waves-effect">Очистить</button>
              
              <div class="right hide-on-small-only">
                 <button id="copyJsonBtn" class="btn-small btn-flat waves-effect"><i class="material-icons left">content_copy</i>JSON</button>
              </div>
            </div>
          </div>

          <!-- Results Area -->
          <div id="resultArea" class="mt-2">
            <!-- Dynamic content here -->
            <div class="center-align" style="padding: 30px; opacity: 0.5">
              <i class="material-icons" style="font-size: 3rem;">compare_arrows</i>
              <p>Вставьте данные и нажмите "Сравнить"</p>
            </div>
          </div>
          
        </div>
      </div>
    </div>

    <!-- VIEW 2: VISUALIZER -->
    <div id="visualizer" class="col s12">
      <div class="card">
        <div class="card-content">
          <span class="card-title">Генератор графика</span>
          <span class="helper-text">Вставьте расписание (одна группа на строку), и мы построим красивый график. Данные сохраняются автоматически.</span>

          <div class="input-field">
            <textarea id="vizInput" class="materialize-textarea" style="min-height: 150px;" placeholder="1.1: 00:00 – 04:00, 09:00 – 13:00&#10;1.2: 02:00 – 06:00"></textarea>
            <label for="vizInput">Данные графика</label>
          </div>

          <div class="row">
            <div class="col s12">
              <button id="generateVizBtn" class="btn btn-large waves-effect waves-light" style="width: 100%">
                <i class="material-icons left">bar_chart</i>
                Построить график
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div> <!-- .container -->

  <!-- MODAL: CHART RESULT -->
  <div id="chartModal" class="modal bottom-sheet-on-mobile">
    <div class="modal-content">
      <h5 class="mb-2">Визуализация отключений</h5>
      
      <!-- Wrapper for horizontal scrolling -->
      <div class="chart-scroll-wrapper" id="chartWrapper">
        <div id="chart-grid">
          <!-- Grid will be injected here -->
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <span class="left hide-on-small-only" style="padding: 10px; color: var(--text-muted); font-size: 0.8rem;">
        * Время указано в заголовках колонок
      </span>
      <a href="#!" class="modal-close btn-flat waves-effect">Закрыть</a>
      <button id="downloadPngBtn" class="btn waves-effect waves-light">
        <i class="material-icons left">download</i>Скачать
      </button>
    </div>
  </div>

  <!-- JS: Materialize + App Logic -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Init Materialize Components
      M.AutoInit();
      
      // --- ЭЛЕМЕНТЫ ---
      const compareBtn = document.getElementById('compareBtn');
      const clearBtn = document.getElementById('clearBtn');
      const copyJsonBtn = document.getElementById('copyJsonBtn');
      const oldInput = document.getElementById('old');
      const newInput = document.getElementById('new');
      const resultArea = document.getElementById('resultArea');
      const onlyChangesCheck = document.getElementById('onlyChanges');

      const generateVizBtn = document.getElementById('generateVizBtn');
      const vizInput = document.getElementById('vizInput');
      const chartModalEl = document.getElementById('chartModal');
      const chartGrid = document.getElementById('chart-grid');
      const downloadPngBtn = document.getElementById('downloadPngBtn');

      // Инициализация модального окна
      const chartModalInstance = M.Modal.getInstance(chartModalEl);


      // --- ЛОКАЛЬНОЕ ХРАНИЛИЩЕ (Загрузка и сохранение) ---
      function loadFromStorage() {
        if (localStorage.getItem('svet_old')) oldInput.value = localStorage.getItem('svet_old');
        if (localStorage.getItem('svet_new')) newInput.value = localStorage.getItem('svet_new');
        if (localStorage.getItem('svet_viz')) vizInput.value = localStorage.getItem('svet_viz');
        
        // Обновляем текстовые поля Materialize (чтобы лейблы не наезжали)
        M.updateTextFields();
        M.textareaAutoResize(oldInput);
        M.textareaAutoResize(newInput);
        M.textareaAutoResize(vizInput);
      }

      // Вешаем слушатели на ввод для автосохранения
      oldInput.addEventListener('input', () => localStorage.setItem('svet_old', oldInput.value));
      newInput.addEventListener('input', () => localStorage.setItem('svet_new', newInput.value));
      vizInput.addEventListener('input', () => localStorage.setItem('svet_viz', vizInput.value));
      
      // Загружаем данные при старте
      loadFromStorage();


      // --- ЛОГИКА КОМПАРАТОРА ---
      function parseBlock(text){
        const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        const data = {};
        const timeRe = /(\d{1,2}:\d{2})\s*[-–—]\s*(\d{1,2}:\d{2})/g;
        for(const line of lines){
          if(!line.includes(':')) continue;
          // Разделяем по первому двоеточию
          const idx = line.indexOf(':');
          const key = line.substring(0, idx).trim();
          const rest = line.substring(idx+1).trim();
          
          const matches = [];
          let m;
          while((m = timeRe.exec(rest)) !== null){
            matches.push([pad(m[1]), pad(m[2])]);
          }
          data[key] = normalizeIntervals(matches);
        }
        return data;
      }

      function pad(t){
        const [h,m] = t.split(':');
        return h.padStart(2,'0') + ':' + m;
      }

      function normalizeIntervals(arr){
        const mapped = arr.map(a=>({s:a[0], e:a[1], str: a[0]+"-"+a[1]}));
        mapped.sort((x,y)=> timeToMin(x.s) - timeToMin(y.s));
        // Уникальность
        const uniq = [];
        for(const it of mapped){
          if(!uniq.length || uniq[uniq.length-1].str !== it.str) uniq.push(it);
        }
        return uniq.map(x=>x.str);
      }

      function timeToMin(t){
        const [h,m] = t.split(':').map(Number);
        return h*60 + m;
      }

      function compareSets(oldArr, newArr){
        const oldSet = new Set(oldArr);
        const newSet = new Set(newArr);
        const removed = [...oldSet].filter(x=>!newSet.has(x));
        const added = [...newSet].filter(x=>!oldSet.has(x));
        // Сортировка
        removed.sort((a,b)=> timeToMin(a.split('-')[0]) - timeToMin(b.split('-')[0]));
        added.sort((a,b)=> timeToMin(a.split('-')[0]) - timeToMin(b.split('-')[0]));
        return {removed, added};
      }

      compareBtn.addEventListener('click', () => {
        const dOld = parseBlock(oldInput.value);
        const dNew = parseBlock(newInput.value);
        const keys = Array.from(new Set([...Object.keys(dOld), ...Object.keys(dNew)])).sort();
        
        resultArea.innerHTML = '';
        const onlyDiff = onlyChangesCheck.checked;
        let hasContent = false;
        
        const summaryJson = {};

        keys.forEach(key => {
          const oldA = dOld[key] || [];
          const newA = dNew[key] || [];
          const diff = compareSets(oldA, newA);
          summaryJson[key] = {old: oldA, new: newA, changes: diff};

          if(onlyDiff && !diff.removed.length && !diff.added.length) return;
          hasContent = true;

          const div = document.createElement('div');
          div.className = 'diff-row';
          
          let html = `
            <div class="diff-header">
              <div>
                <span style="font-weight:bold; font-size:1.1rem">${escapeHtml(key)}</span>
                <span class="grey-text text-lighten-1" style="font-size:0.85rem; margin-left:10px">
                   ${newA.length ? newA.length + ' интервалов' : 'Пусто'}
                </span>
              </div>
              <div style="text-align:right">
                ${diff.removed.map(r => `<span class="chip removed">-${r}</span>`).join('')}
                ${diff.added.map(a => `<span class="chip added">+${a}</span>`).join('')}
              </div>
            </div>
            <details>
              <summary>Подробнее</summary>
              <pre style="white-space:pre-wrap; font-family:monospace; font-size:0.9rem; margin-top:5px; color:#ccc">Старое: ${oldA.join(', ') || '—'}\nНовое:  ${newA.join(', ') || '—'}</pre>
            </details>
          `;
          div.innerHTML = html;
          resultArea.appendChild(div);
        });

        if(!hasContent) {
          resultArea.innerHTML = '<div class="center-align muted">Нет изменений или данных</div>';
        }
        // Сохраняем для JSON
        resultArea.dataset.json = JSON.stringify(summaryJson, null, 2);
      });

      clearBtn.addEventListener('click', ()=>{
        oldInput.value = ''; newInput.value = ''; resultArea.innerHTML = '';
        localStorage.removeItem('svet_old');
        localStorage.removeItem('svet_new');
        M.textareaAutoResize(oldInput);
        M.textareaAutoResize(newInput);
      });

      copyJsonBtn.addEventListener('click', ()=>{
        const txt = resultArea.dataset.json || '{}';
        navigator.clipboard.writeText(txt).then(()=> M.toast({html: 'JSON скопирован'}));
      });


      // --- ЛОГИКА ВИЗУАЛИЗАТОРА (MODAL) ---
      function parseTimeMinutes(str) {
        if(str === '24:00') return 1440;
        const [h, m] = str.split(':').map(Number);
        return h*60 + m;
      }

      function mergeIntervals(ranges) {
        if(!ranges.length) return [];
        ranges.sort((a,b) => a.start - b.start);
        const result = [];
        let curr = {...ranges[0]};
        for(let i=1; i<ranges.length; i++){
          if(ranges[i].start <= curr.end) {
            curr.end = Math.max(curr.end, ranges[i].end);
          } else {
            result.push(curr);
            curr = {...ranges[i]};
          }
        }
        result.push(curr);
        return result;
      }

      function fmtDuration(mins) {
        const h = Math.floor(mins/60);
        const m = mins % 60;
        let s = '';
        if(h > 0) s += h + 'ч ';
        if(m > 0) s += m + 'мин';
        return s.trim() || '0мин';
      }

      function generateChart() {
        const text = vizInput.value;
        const lines = text.trim().split('\n');
        const data = [];
        
        // Regex для строки вида "Группа: время"
        const lineRe = /^([^:]+):\s*(.*)$/; 
        const timeRe = /(\d{1,2}:\d{2})\s*[-–—]\s*(\d{1,2}:\d{2})/g;

        for(const line of lines){
          const match = line.trim().match(lineRe);
          if(!match) continue;
          
          const groupName = match[1].trim();
          const timeStr = match[2];
          const ranges = [];
          
          let tm;
          while((tm = timeRe.exec(timeStr)) !== null){
            ranges.push({
              start: parseTimeMinutes(pad(tm[1])),
              end: parseTimeMinutes(pad(tm[2]))
            });
          }
          
          const merged = mergeIntervals(ranges);
          const totalMins = merged.reduce((acc, r) => acc + (r.end - r.start), 0);
          
          data.push({
            group: groupName,
            ranges: merged,
            totalMinsNumeric: totalMins,
            totalStr: fmtDuration(totalMins)
          });
        }

        if(!data.length) {
          M.toast({html: 'Нет данных для отображения', classes: 'red'});
          return;
        }

        renderGrid(data);
        chartModalInstance.open();
      }

      function renderGrid(data) {
        chartGrid.innerHTML = '';
        
        // 1. Заголовок (пустой угол)
        const corner = document.createElement('div');
        corner.className = 'grid-cell corner-cell';
        corner.style.borderRight = 'none'; 
        chartGrid.appendChild(corner);

        // 2. Часы (00..23)
        for(let h=0; h<24; h++){
          const cell = document.createElement('div');
          cell.className = 'grid-cell header-cell';
          cell.textContent = h.toString().padStart(2,'0') + ':00';
          chartGrid.appendChild(cell);
        }

        // 3. Данные
        data.forEach(item => {
          // Лейбл группы + общее время
          const label = document.createElement('div');
          label.className = 'grid-cell label-cell';
          label.innerHTML = `
            <span>${escapeHtml(item.group)}</span>
            <span class="total-time">(${item.totalStr})</span>
          `;
          chartGrid.appendChild(label);

          // 48 ячеек по 30 минут
          for(let i=0; i<48; i++){
            const start = i*30;
            const end = (i+1)*30;
            
            // Проверка пересечения
            const isOff = item.ranges.some(r => start < r.end && end > r.start);
            
            const cell = document.createElement('div');
            cell.className = `grid-cell data-cell ${isOff ? 'off' : ''}`;
            if(isOff) {
              cell.innerHTML = `<i class="material-icons" style="font-size:14px">flash_off</i>`;
            }
            chartGrid.appendChild(cell);
          }
        });

        // 4. СТРОКА ИТОГО ВНИЗУ (НОВОЕ)
        // Считаем сумму всех отключений по всем группам
        const grandTotalMins = data.reduce((acc, item) => acc + item.totalMinsNumeric, 0);
        
        const footerRow = document.createElement('div');
        footerRow.className = 'grid-footer';
        footerRow.innerHTML = `Всего времени отсутствия света (сумма по группам): <strong>${fmtDuration(grandTotalMins)}</strong>`;
        chartGrid.appendChild(footerRow);
      }

      function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

      // --- СКАЧИВАНИЕ ---
      downloadPngBtn.addEventListener('click', function() {
        const el = document.getElementById('chart-grid');
        
        const originalText = this.innerHTML;
        this.innerHTML = 'Генерация...';
        this.disabled = true;

        html2canvas(el, {
          backgroundColor: '#0f1724',
          scale: 2 
        }).then(canvas => {
          const link = document.createElement('a');
          link.download = 'svet-chart.png';
          link.href = canvas.toDataURL();
          link.click();
        }).catch(err => {
          console.error(err);
          M.toast({html: 'Ошибка сохранения', classes: 'red'});
        }).finally(() => {
          this.innerHTML = originalText;
          this.disabled = false;
        });
      });

      generateVizBtn.addEventListener('click', generateChart);
    });
  </script>
</body>
</html>
